<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GeoDrag Game</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: Arial, sans-serif;
      background: #eef2f5;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }
    h1 { margin-bottom: 10px; }
    #level {
      font-size: 20px;
      margin-bottom: 10px;
      color: #333;
      font-weight: bold;
    }
    #game-wrapper {
      position: relative;
      width: 90vw;
      max-width: 450px;
    }
    #game-container {
      width: 100%;
      aspect-ratio: 450 / 360;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(3, 1fr);
      border: 4px solid #333;
      background: #fff;
      position: relative;
      touch-action: none;
    }
    .street-label.horizontal {
      position: absolute;
      background: #eef2f5;
      padding: 0 8px;
      font-weight: bold;
      font-size: 18px;
      color: #333;
      z-index: 5;
    }
    .street-label.horizontal.top {
      top: -12px;
      left: 50%;
      transform: translateX(-50%);
    }
    .street-label.horizontal.bottom {
      bottom: -12px;
      left: 50%;
      transform: translateX(-50%);
    }
    .street-label.vertical {
      position: absolute;
      top: 50%;
      left: calc(66.666% + 4px);
      background: #eef2f5;
      padding: 0 8px;
      font-weight: bold;
      font-size: 18px;
      color: #333;
      transform: translate(-50%, -50%) rotate(90deg);
      z-index: 5;
    }
    .cell {
      border: 1px solid #ccc;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    .stack {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .stack .label {
      margin-top: 4px;
      font-size: 12px;
      color: #333;
    }
    #character {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #ff6b6b;
      position: absolute;
      z-index: 10;
      cursor: grab;
      touch-action: none;
    }
    .marker {
      position: absolute;
      width: 24px;
      height: 24px;
      background: #3498db;
      color: #fff;
      font-size: 14px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      opacity: 0;
      transition: opacity 0.4s ease;
      pointer-events: none;
    }
    .marker.show { opacity: 1; }
    #ui { margin-top: 20px; text-align: center; }
    #scoreboard { margin-bottom: 10px; }
    button {
      padding: 8px 16px;
      margin: 5px;
      border: none;
      border-radius: 4px;
      background: #333;
      color: #fff;
      cursor: pointer;
      transition: background 0.2s;
    }
    button:hover { background: #555; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <h1>GeoDrag - Guess the Place</h1>
  <div id="level">LEVEL 1</div>
  <div id="game-wrapper">
    <div class="street-label horizontal top">Main Avenue</div>
    <div id="game-container">
      <div class="street-label vertical">New York Street</div>
      <!-- Row 1 -->
      <div class="cell"><div class="stack"><span id="Supermarket">üõí</span><span class="label">Supermarket</span></div></div>
      <div class="cell"><div class="stack"><span id="Circus">üé™</span><span class="label">Circus</span></div></div>
      <div class="cell"><div class="stack"><span id="University">üéì</span><span class="label">University</span></div></div>
      <!-- Row 2 -->
      <div class="cell"><div class="stack"><span id="Hospital">üè•</span><span class="label">Hospital</span></div></div>
      <div class="cell"><div class="stack"><span id="Pharmacy">üíä</span><span class="label">Pharmacy</span></div></div>
      <div class="cell"><div class="stack"><span id="Stadium">üèüÔ∏è</span><span class="label">Stadium</span></div></div>
      <!-- Row 3 -->
      <div class="cell"><div class="stack"><span id="Church">‚õ™</span><span class="label">Church</span></div></div>
      <div class="cell"><div class="stack"><span id="Park">üå≥</span><span class="label">Park</span></div></div>
      <div class="cell"><div class="stack"><span id="Library">üìö</span><span class="label">Library</span></div></div>
      <!-- Movable character -->
      <div id="character"></div>
    </div>
    <div class="street-label horizontal bottom">Columbus Avenue</div>
  </div>
  <div id="ui">
    <div id="scoreboard">Attempt <span id="round">1</span>/5 ‚Äî Total Score: <span id="total">0</span></div>
    <div id="message"></div>
    <button id="retry" class="hidden">Retry</button>
    <button id="next" class="hidden">Next</button>
  </div>

  <script>
    const order = ['Supermarket','Circus','Pharmacy','Stadium','Library'];
    const levelMessages = [
      "Walk half a block to the left, go one full block forward toward Main Avenue, turn left, and you‚Äôll find it right in front of the hospital.",
      "Walk half a block to the right toward New York Street, go one full block forward, then turn left ‚Äî you‚Äôll arrive at your destination.",
      "You‚Äôll find it sitting directly in front of the park, between the hospital and the stadium.",
      "Walk all the way to the right, and you‚Äôll see it on your left, right across from the library.",
      "Walk all the way to the right, and you‚Äôll see it on your right, right across from the stadium."
    ];
    const elems = {};
    order.forEach(id => elems[id] = document.getElementById(id));
    const container = document.getElementById('game-container');
    const char = document.getElementById('character');
    const msg = document.getElementById('message');
    const retryBtn = document.getElementById('retry');
    const nextBtn = document.getElementById('next');
    const roundEl = document.getElementById('round');
    const totalEl = document.getElementById('total');
    const levelEl = document.getElementById('level');
    let current = 0, totalScore = 0, threshold = 30;

    function setInitialPosition() {
      const cellIndex = 7; // bottom middle cell
      const cells = container.querySelectorAll('.cell');
      const rect = cells[cellIndex].getBoundingClientRect();
      const crect = container.getBoundingClientRect();
      char.style.left = `${rect.left + rect.width/2 - crect.left - char.offsetWidth/2}px`;
      // moved up 20px for better positioning, above the street line
      char.style.top  = `${rect.top + rect.height/2 - crect.top - char.offsetHeight/2 - 20}px`;
    }

    window.onload = () => {
      msg.textContent = levelMessages[0];
      setTimeout(setInitialPosition, 50);
    };

    // Unified pointer events handling for mouse and touch
    let dragging = false, offsetX = 0, offsetY = 0;
    char.addEventListener('pointerdown', e => {
      dragging = true;
      char.setPointerCapture(e.pointerId);
      const crect = container.getBoundingClientRect();
      offsetX = e.clientX - (char.offsetLeft + crect.left);
      offsetY = e.clientY - (char.offsetTop + crect.top);
      char.style.cursor = 'grabbing';
    });

    char.addEventListener('pointermove', e => {
      if (!dragging) return;
      const crect = container.getBoundingClientRect();
      let x = e.clientX - crect.left - offsetX;
      let y = e.clientY - crect.top - offsetY;
      x = Math.max(0, Math.min(x, crect.width - char.offsetWidth));
      y = Math.max(0, Math.min(y, crect.height - char.offsetHeight));
      char.style.left = `${x}px`;
      char.style.top = `${y}px`;
    });

    char.addEventListener('pointerup', e => {
      if (!dragging) return;
      dragging = false;
      char.releasePointerCapture(e.pointerId);
      char.style.cursor = 'grab';
      const crect = container.getBoundingClientRect();
      const x = e.clientX - crect.left;
      const y = e.clientY - crect.top;
      evaluate(x, y);
    });

    retryBtn.onclick = () => { msg.textContent = 'Try again...'; clearMarkers(); retryBtn.classList.add('hidden'); };
    nextBtn.onclick = () => {
      clearMarkers();
      current++;
      if (current >= order.length) {
        msg.textContent = `Game over! Final score: ${totalScore}`;
        nextBtn.classList.add('hidden');
        return;
      }
      roundEl.textContent = current + 1;
      levelEl.textContent = `LEVEL ${current + 1}`;
      msg.textContent = levelMessages[current];
      setTimeout(setInitialPosition, 50);
      nextBtn.classList.add('hidden');
    };

    function evaluate(x, y) {
      const targetRect = elems[order[current]].closest('.cell').getBoundingClientRect();
      const crect = container.getBoundingClientRect();
      const tx = targetRect.left + targetRect.width/2 - crect.left;
      const ty = targetRect.top + targetRect.height/2 - crect.top;
      const dist = Math.hypot(x - tx, y - ty);
      let score;
      if (dist < threshold) {
        score = 100;
        msg.textContent = 'Correct! 100 points.';
      } else {
        score = Math.round((1 - Math.min(dist, 400)/400) * 9) + 1;
        msg.textContent = `Distance: ${Math.round(dist)}px ‚Üí ${score} pts.`;
        retryBtn.classList.remove('hidden');
      }
      totalScore += score;
      totalEl.textContent = totalScore;
      placeMarker(x, y, current + 1);
      nextBtn.classList.remove('hidden');
    }

    function placeMarker(x, y, label) {
      const m = document.createElement('div');
      m.className = 'marker';
      m.textContent = label;
      m.style.left = `${x - 12}px`;
      m.style.top  = `${y - 12}px`;
      container.appendChild(m);
      requestAnimationFrame(() => m.classList.add('show'));
    }

    function clearMarkers() {
      document.querySelectorAll('.marker').forEach(m => m.remove());
    }
  </script>
</body>
</html>
